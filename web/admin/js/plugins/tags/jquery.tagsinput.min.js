(function(d){var c=new Array();var b=new Array();d.fn.doAutosize=function(g){var l=d(this).data("minwidth"),q=d(this).data("maxwidth"),h="",n=d(this),f=d("#"+d(this).data("tester_id"));if(h===(h=n.val())){return}var m=h.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");f.html(m);var p=f.width(),j=(p+g.comfortZone)>=l?p+g.comfortZone:l,e=n.width(),k=(j<e&&j>=l)||(j>l&&j<q);if(k){n.width(j)}};d.fn.resetAutosize=function(g){var f=d(this).data("minwidth")||g.minInputWidth||d(this).width(),k=d(this).data("maxwidth")||g.maxInputWidth||(d(this).closest(".tagsinput").width()-g.inputPadding),l="",e=d(this),h=d("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:e.css("fontSize"),fontFamily:e.css("fontFamily"),fontWeight:e.css("fontWeight"),letterSpacing:e.css("letterSpacing"),whiteSpace:"nowrap"}),j=d(this).attr("id")+"_autosize_tester";if(!d("#"+j).length>0){h.attr("id",j);h.appendTo("body")}e.data("minwidth",f);e.data("maxwidth",k);e.data("tester_id",j);e.css("width",f)};d.fn.addTag=function(f,e){e=jQuery.extend({focus:false,callback:true},e);this.each(function(){var l=d(this).attr("id");var j=d(this).val().split(c[l]);if(j[0]==""){j=new Array()}f=jQuery.trim(f);if(e.unique){var g=d(this).tagExist(f);if(g==true){d("#"+l+"_tag").addClass("not_valid")}}else{var g=false}if(f!=""&&g!=true){d("<span>").addClass("tag").append(d("<span>").text(f).append("&nbsp;&nbsp;"),d("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return d("#"+l).removeTag(escape(f))})).insertBefore("#"+l+"_addTag");j.push(f);d("#"+l+"_tag").val("");if(e.focus){d("#"+l+"_tag").focus()}else{d("#"+l+"_tag").blur()}d.fn.tagsInput.updateTagsField(this,j);if(e.callback&&b[l]&&b[l]["onAddTag"]){var k=b[l]["onAddTag"];k.call(this,f)}if(b[l]&&b[l]["onChange"]){var h=j.length;var k=b[l]["onChange"];k.call(this,d(this),j[h-1])}}});return false};d.fn.removeTag=function(e){e=unescape(e);this.each(function(){var j=d(this).attr("id");var g=d(this).val().split(c[j]);d("#"+j+"_tagsinput .tag").remove();str="";for(i=0;i<g.length;i++){if(g[i]!=e){str=str+c[j]+g[i]}}d.fn.tagsInput.importTags(this,str);if(b[j]&&b[j]["onRemoveTag"]){var h=b[j]["onRemoveTag"];h.call(this,e)}});return false};d.fn.tagExist=function(f){var g=d(this).attr("id");var e=d(this).val().split(c[g]);return(jQuery.inArray(f,e)>=0)};d.fn.importTags=function(e){var f=d(this).attr("id");d("#"+f+"_tagsinput .tag").remove();d.fn.tagsInput.importTags(this,e)};d.fn.tagsInput=function(f){var g=jQuery.extend({interactive:true,defaultText:"添加标签",minChars:0,width:"300px",height:"40px",autocomplete:{selectFirst:false},hide:true,delimiter:",",unique:true,removeWithBackspace:true,placeholderColor:"#666666",autosize:true,comfortZone:20,inputPadding:6*2},f);var e=0;this.each(function(){if(typeof d(this).attr("data-tagsinput-init")!=="undefined"){return}d(this).attr("data-tagsinput-init",true);if(g.hide){d(this).hide()}var k=d(this).attr("id");if(!k||c[d(this).attr("id")]){k=d(this).attr("id","tags"+new Date().getTime()+(e++)).attr("id")}var j=jQuery.extend({pid:k,real_input:"#"+k,holder:"#"+k+"_tagsinput",input_wrapper:"#"+k+"_addTag",fake_input:"#"+k+"_tag"},g);c[k]=j.delimiter;if(g.onAddTag||g.onRemoveTag||g.onChange){b[k]=new Array();b[k]["onAddTag"]=g.onAddTag;b[k]["onRemoveTag"]=g.onRemoveTag;b[k]["onChange"]=g.onChange}var h='<div id="'+k+'_tagsinput" class="tagsinput"><div id="'+k+'_addTag">';if(g.interactive){h=h+'<input id="'+k+'_tag" value="" data-default="'+g.defaultText+'" />'}h=h+'</div><div class="tags_clear"></div></div>';d(h).insertAfter(this);d(j.holder).css("width",g.width);d(j.holder).css("min-height",g.height);d(j.holder).css("height",g.height);if(d(j.real_input).val()!=""){d.fn.tagsInput.importTags(d(j.real_input),d(j.real_input).val())}if(g.interactive){d(j.fake_input).val(d(j.fake_input).attr("data-default"));d(j.fake_input).css("color",g.placeholderColor);d(j.fake_input).resetAutosize(g);d(j.holder).bind("click",j,function(l){d(l.data.fake_input).focus()});d(j.fake_input).bind("focus",j,function(l){if(d(l.data.fake_input).val()==d(l.data.fake_input).attr("data-default")){d(l.data.fake_input).val("")}d(l.data.fake_input).css("color","#000000")});if(g.autocomplete_url!=undefined){autocomplete_options={source:g.autocomplete_url};for(attrname in g.autocomplete){autocomplete_options[attrname]=g.autocomplete[attrname]}if(jQuery.Autocompleter!==undefined){d(j.fake_input).autocomplete(g.autocomplete_url,g.autocomplete);d(j.fake_input).bind("result",j,function(l,n,m){if(n){d("#"+k).addTag(n[0]+"",{focus:true,unique:(g.unique)})}})}else{if(jQuery.ui.autocomplete!==undefined){d(j.fake_input).autocomplete(autocomplete_options);d(j.fake_input).bind("autocompleteselect",j,function(l,m){d(l.data.real_input).addTag(m.item.value,{focus:true,unique:(g.unique)});return false})}}}else{d(j.fake_input).bind("blur",j,function(l){var m=d(this).attr("data-default");if(d(l.data.fake_input).val()!=""&&d(l.data.fake_input).val()!=m){if((l.data.minChars<=d(l.data.fake_input).val().length)&&(!l.data.maxChars||(l.data.maxChars>=d(l.data.fake_input).val().length))){d(l.data.real_input).addTag(d(l.data.fake_input).val(),{focus:true,unique:(g.unique)})}}else{d(l.data.fake_input).val(d(l.data.fake_input).attr("data-default"));d(l.data.fake_input).css("color",g.placeholderColor)}return false})}d(j.fake_input).bind("keypress",j,function(l){if(a(l)){l.preventDefault();if((l.data.minChars<=d(l.data.fake_input).val().length)&&(!l.data.maxChars||(l.data.maxChars>=d(l.data.fake_input).val().length))){d(l.data.real_input).addTag(d(l.data.fake_input).val(),{focus:true,unique:(g.unique)})}d(l.data.fake_input).resetAutosize(g);return false}else{if(l.data.autosize){d(l.data.fake_input).doAutosize(g)}}});j.removeWithBackspace&&d(j.fake_input).bind("keydown",function(m){if(m.keyCode==8&&d(this).val()==""){m.preventDefault();var l=d(this).closest(".tagsinput").find(".tag:last").text();var n=d(this).attr("id").replace(/_tag$/,"");l=l.replace(/[\s]+x$/,"");d("#"+n).removeTag(escape(l));d(this).trigger("focus")}});d(j.fake_input).blur();if(j.unique){d(j.fake_input).keydown(function(l){if(l.keyCode==8||String.fromCharCode(l.which).match(/\w+|[áéíóúÁÉÍÓÚñÑ,/]+/)){d(this).removeClass("not_valid")}})}}});return this};d.fn.tagsInput.updateTagsField=function(f,e){var g=d(f).attr("id");d(f).val(e.join(c[g]))};d.fn.tagsInput.importTags=function(h,j){d(h).val("");var k=d(h).attr("id");var e=j.split(c[k]);for(i=0;i<e.length;i++){d(h).addTag(e[i],{focus:false,callback:false})}if(b[k]&&b[k]["onChange"]){var g=b[k]["onChange"];g.call(h,h,e[i])}};var a=function(e){var f=false;if(e.which==13){return true}if(typeof e.data.delimiter==="string"){if(e.which==e.data.delimiter.charCodeAt(0)){f=true}}else{d.each(e.data.delimiter,function(g,h){if(e.which==h.charCodeAt(0)){f=true}})}return f}})(jQuery);